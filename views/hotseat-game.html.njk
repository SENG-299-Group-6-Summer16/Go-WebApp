{% extends "views/base.html.njk" %}

{% block title %}Quick Game{% endblock %}

{% block content %}
	<div class="page-header">
		<h1>Hotseat Game</h1>
		<p class="lead">
			Choose your type of game below. Note that these games are not saved to your account, and do not affect your
			player score.
		</p>
	</div>

	<div class="row">
		<div class="col-md-8 col-md-offset-2">
			<div style="border: 3px solid black; border-radius:5px; background-color: #DBB15B; padding: 5px">
				<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 1000 1000" id="board"></svg>
			</div>

			Current turn: <strong id="current_turn"></strong>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div id="messages"></div>
		</div>
	</div>
{% endblock %}

{% block javascript %}
	<script src="/js/boardDrawer.js"></script>
	<script>
		var $board, $messages, $currentTurn, $send, $x, $y;

		var currentTurn = 1;

		function addError(error) {
			$messages.append($('<div>').append($('<em class="text-danger">').text(error)));
		}

		function changeTurn(turn) {
			if (turn === 1) {
				$currentTurn.text('Black');
				currentTurn = turn;
			} else if (turn === 2) {
				$currentTurn.text('White');
				currentTurn = turn;
			} else {
				$currentTurn.text('Something\'s fucky');
			}
		}

		$(document).ready(function() {
			// Set up globals
			$board = $('#board');
			$messages = $('#messages');
			$currentTurn = $('#current_turn');
			$send = $('#send');
			$x = $('#x');
			$y = $('#y');

			var gameSocket = new WebSocket('ws://' + window.location.host + '{{ routes.joinHotseatGame|replace(':id', gameId|urlencode) }}');

			gameSocket.onmessage = function (event) {
				var message = JSON.parse(event.data);

				if (message.error) {
					addError(message.error);
				}

				if (message.nextTurn) {
					changeTurn(message.nextTurn);
				}

				if (message.board) {
					boardDrawer.drawBoard(message.board, $board, currentTurn);
				}
			};

			gameSocket.onclose = function (event) {
				if (event.reason) {
					addError('Connection closed by server: ' + event.reason);
				} else {
					addError('Lost connection to server.');
				}

				window.onbeforeunload = null;
			};

			// Handle token hover
			boardDrawer.registerEvents($board, function(x, y) {
				gameSocket.send(JSON.stringify({move: {x: parseInt(x), y: parseInt(y)}, color: currentTurn}));
			});

			// Warn user when navigating away that they will leave the lobby
			window.onbeforeunload = function() {
				// Newest chrome doesn't allow for custom string, but we'll leave it here for other browsers
				return "Navigating away from this page will remove you from the game. Are you sure you wish to continue?";
			};

			window.onunload = function() {
				gameSocket.close();
			};
		});
	</script>
{% endblock %}
